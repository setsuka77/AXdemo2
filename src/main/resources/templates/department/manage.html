<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>部署管理登録 | Analix社内管理システム</title>
	<link rel="stylesheet" href="/login/css/styles.css">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body>

	<div class="container">
		<div class="form-container">
			<tr>
				<div class="header-button">
					<form th:action="@{/department/manage}" method="post">
						<button type="submit" name="back" class="button">メニュー</button>
					</form>
					<h2>部署管理</h2>
					<a th:href="@{/logout}"><button>ログオフ</button></a>
				</div>
			</tr>

			<!-- 部署管理フォーム -->
			<form id="departmentForm" th:action="@{/department/manage}" method="post" th:object="${departmentForm}">

				<!-- 成功メッセージ表示 -->
				<div th:if="${successMessage}" class="alert alert-success" role="alert">
					<p th:utext="${successMessage}"></p>
				</div>

				<!-- 新規部署名入力 -->
				<div class="input-group">
					<label for="newDepartment">部署名</label>
					<input type="text" id="newDepartment" name="newDepartment" onkeyup="searchDepartment()"
						autocomplete="off" />
					<div class="error-message" id="errorNewDepartment"></div>
				</div>

				<!-- 登録済の部署表示選択プルダウン -->
				<div class="input-group">
					<label for="currentDepartment">登録済部署</label>

					<select name="currentDepartment" id="currentDepartment">
						<option value="">選択してください</option>
						<option th:each="department : ${departments}" th:value="${department.name}"
							th:text="${department.name}">選択肢
						</option>
					</select>
				</div>
				<!-- エラーメッセージ表示 -->
				<div th:if="${errorMessage}" class="alert alert-danger" role="alert">
					<p th:utext="${errorMessage}"></p>
				</div>

				<div class="button-group">
					<button type="submit" name="register" class="button" onClick="return confirmRegistration()">新規登録</button>
					<button type="submit" name="update" class="button" onClick="return confirmUpdate()">部署名変更</button>
					<button type="submit" name="deactivate" class="button" onClick="return confirmDeactivate()">部署停止</button>
					<button type="submit" name="restart" class="button" onClick="return confirmRestart()">再開</button>
				</div>


			</form>

		</div>
	</div>

	<script>
		// リアルタイムで検索結果を表示
		document.getElementById('newDepartment').addEventListener('input', function () {
			const name = this.value;
			const currentDepartment = document.getElementById('currentDepartment').value;

			// プルダウンが選択されていないときのみ検索を実行
			if (currentDepartment === "") {
				// Fetch APIで検索リクエストを送信
				fetch(`/login/department/search?name=${name}`)
					.then(response => response.json())
					.then(data => {
						const select = document.getElementById('currentDepartment');
						select.innerHTML = '<option value="">選択してください</option>'; // クリア

						// 検索結果をプルダウンに表示
						data.forEach(department => {
							const option = document.createElement('option');
							option.value = department.name;
							option.textContent = department.name;
							select.appendChild(option);
						});
					})
					.catch(error => console.error('Error:', error));
			}
		});


		// 部署のプルダウンメニューから選択された値をテキストフィールドに反映
		document.getElementById('currentDepartment').addEventListener('change', function () {
			var selectedDepartment = this.value;
			document.getElementById('newDepartment').value = selectedDepartment; // テキストフィールドに反映
		});


		//登録ボタン押下時確認ダイアログ
		function confirmRegistration() {
			const newDepartment = document.getElementById('newDepartment').value;
			const currentDepartment = document.getElementById('currentDepartment').value;
			return confirm(`部署名: ${newDepartment}\nこの内容で登録します。よろしいですか？`);
		}

		//部署名変更ボタン押下時確認ダイアログ
		function confirmUpdate() {
			const newDepartment = document.getElementById('newDepartment').value;
			const currentDepartment = document.getElementById('currentDepartment').value;
			return confirm(`部署名: ${newDepartment}\n選択中の登録済部署: ${currentDepartment}\nこの部署名を変更します。よろしいですか？`);
		}

		//停止ボタン押下時確認ダイアログ
		function confirmDeactivate() {
			const currentDepartment = document.getElementById('currentDepartment').value;
			return confirm(`選択中の部署: ${currentDepartment}\nこの部署を停止します。よろしいですか？`);
		}

		//再開ボタン押下時確認ダイアログ
		function confirmRestart() {
			const currentDepartment = document.getElementById('currentDepartment').value;
			return confirm(`選択中の部署: ${currentDepartment}\nこの部署を再開します。よろしいですか？`);
		}



		//＊＊ボタンの活性非活性ができるまでの必須チェック＊＊//
		document.addEventListener("DOMContentLoaded", function () {
			// フォームの要素を取得
			const departmentForm = document.getElementById("departmentForm");

			// エラーメッセージを表示する関数
			const showError = (input, errorElement, message) => {
				if (input.value.trim() === "") {
					errorElement.textContent = message;
					errorElement.style.display = "block";
					return false;
				} else {
					errorElement.style.display = "none";
					return true;
				}
			};
			// フォームが送信されたときの処理
			departmentForm.addEventListener("submit", function (event) {
				// 部署名の入力フィールドとエラーメッセージ要素を取得
				const newDepartmentInput = document.getElementById("newDepartment");
				const newDepartmentError = document.getElementById("errorNewDepartment");

				// ボタンが「新規登録」か「部署名変更」だった場合、必須入力チェックを行う
				const registerButtonClicked = document.querySelector("button[name='register']:focus");
				const updateButtonClicked = document.querySelector("button[name='update']:focus");

				if (registerButtonClicked || updateButtonClicked) {
					const isDepartmentValid = showError(newDepartmentInput, errorNewDepartment, "部署名を入力してください。");

					// 入力が無効な場合、フォームの送信を中止
					if (!isDepartmentValid) {
						event.preventDefault();
					}
				}
			});
		});

	</script>


</body>

</html>
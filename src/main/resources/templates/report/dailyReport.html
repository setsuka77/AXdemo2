<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>日報管理画面 | Analix社内管理システム</title>
	<link rel="stylesheet" href="/login/styles.css">
</head>

<body>
	<div class="dailyReport-container">
		<tr>
			<div class="header-button">
				<form th:action="@{/report/dailyReport}" method="post">
					<button type="submit" name="back" class="button">メニュー</button>
				</form>
				<h2>日報管理</h2>
				<a th:href="@{/logout}"><button>ログオフ</button></a>
			</div>
		</tr>

		<tr>
			<td>
				<div class="info-container">
					<div class="info-item">ユーザー名: <span th:text="${loginUser.name}"></span></div>
					<div class="info-item">ユーザーID: <span th:text="${loginUser.id}"></span></div>
					<div class="info-item" th:if="${loginUser.role != '2'}">ステータス: <span th:text="${statusText}" id="statusText"></span>
					</div>
				</div>
			</td>
		</tr>

		<!-- 対象日付を指定して表示 メンバー/UM -->
		<form id="report-form" th:action="@{/report/dailyReport}" method="post" th:if="${loginUser.role != '2'}">
			<div class="form-group">
				対象日付:
				<input type="date" name="selectDate" th:value="${selectDate}" onchange="fetchReport()" id="dateInput">
			</div>

			<div class="button-group">
				<button type="submit" th:if="${loginUser.role != '2'}" name="submit" id="submit"
					class="button">提出</button>
			</div>

			<!-- 登録時入力エラーメッセージ表示 -->
			<div th:if="${registerError}" class="alert alert-danger" role="alert">
				<p th:utext="${registerError}"></p>
			</div>
			<!-- 登録完了メッセージ表示 -->
			<div th:if="${message}" class="alert alert-success" role="alert">
				<p th:utext="${message}"></p>
			</div>

			<table class="table table-hover" border="1" cellspacing="0" id="report">
				<thead>
					<tr>
						<th>作業時間(h)</th>
						<th>作業内容</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="detail, iterStat : ${dailyReportForm.dailyReportDetailFormList}"
						th:classappend="${detail.errorFlag ? 'error-field' : ''}">
						<td>
							<input type="number" th:name="'dailyReportDetailFormList[' + ${iterStat.index} + '].time'"
								th:value="${detail.time}" id="time" min="0" step="1"> h
						</td>
						<td class="textarea-wrapper">
							<textarea id="content"
								th:name="'dailyReportDetailFormList[' + ${iterStat.index} + '].content'"
								th:text="${detail.content}" class="textarea note" rows="2" cols="60"></textarea>
							<div class="char-counter" id="charCounter">0 / 50</div>
						</td>
					</tr>
				</tbody>
			</table>
		</form>
	</div>

	<script>
		
		// 日付を選択した瞬間にDBから情報を取得する
        function fetchReport() {
            var selectDate = document.getElementById('dateInput').value;

            fetch('/login/report/dailyReport', { // Controllerのエンドポイントに合わせる
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ selectDate: selectDate })
            })
           	.then(response => response.json())
				.then(data => {
					if (data) {
						// データが存在する場合の処理
						const reportDetails = data.reportDetails;
						const statusText = data.statusText;
						// 日報データをフォームに代入
						if (reportDetails && reportDetails.length > 0) {
							populateForm(reportDetails);
						} else {
							// データがない場合の処理
							clearForm();
							console.log('No data found for the selected date.');
						}
						
						// ステータスを表示
						const statusElement = document.querySelector('.info-item span');
						if (statusElement) {
							statusElement.textContent = statusText;
						}
					} else {
						// データがない場合の処理
						// 既存のフォーム要素を取得
						const timeInputs = document.querySelectorAll('input[name^="dailyReportDetailFormList"]');
						const contentTextareas = document.querySelectorAll('textarea[name^="dailyReportDetailFormList"]');

						// 既存の行をクリア
						timeInputs.forEach(input => input.value = '');
						contentTextareas.forEach(textarea => textarea.value = '');
						console.log('No data found for the selected date.');
						
						// 文字数カウンターを更新
							const charCounter = contentTextareas[index].nextElementSibling;
							if (charCounter) {
								charCounter.textContent = `${detail.content.length} / 50`;
							}
						
					}
				})
			.catch(error => {
					console.error('Error fetching data:', error);
				});
			}
			
			function populateForm(data) {
					// 既存のフォーム要素を取得
					const timeInputs = document.querySelectorAll('input[name^="dailyReportDetailFormList"]');
					const contentTextareas = document.querySelectorAll('textarea[name^="dailyReportDetailFormList"]');

					// 既存の行をクリア
					timeInputs.forEach(input => input.value = '');
					contentTextareas.forEach(textarea => textarea.value = '');

					// 新しいデータをフォームに代入
					data.forEach((detail, index) => {
						if (timeInputs[index]) {
							timeInputs[index].value = detail.time;
						}
						if (contentTextareas[index]) {
							contentTextareas[index].value = detail.content;
							// 文字数カウンターを更新
							const charCounter = contentTextareas[index].nextElementSibling;
							if (charCounter) {
								charCounter.textContent = `${detail.content.length} / 50`;
							}
						}
					});
				}


		// テキストエリアの高さ調整と文字数カウンター
		const textareas = document.querySelectorAll(".textarea");

		const adjustHeight = (textarea) => {
			textarea.style.height = 'auto';
			textarea.style.height = `${textarea.scrollHeight}px`;
		};

		textareas.forEach(textarea => {
			const maxLength = 50;
			const charCounter = textarea.nextElementSibling;

			// 初期カウント表示
			charCounter.textContent = `${textarea.value.length} / ${maxLength}`;

			// 初期の高さ調整
			adjustHeight(textarea);

			// textareaに文字が入力されるたびに
			textarea.addEventListener("input", () => {
				// その時点での文字数を取得する 
				const currentLength = textarea.value.length;
				// 「現在文字数 / 最大文字数」というテキストを作って文字数カウンター要素に入れる
				charCounter.textContent = `${currentLength} / ${maxLength}`;

				// 高さを調整する
				adjustHeight(textarea);
			});

			// ウィンドウサイズが変わったときに高さを再調整
			window.addEventListener("resize", () => adjustHeight(textarea));
		});


		// 提出ボタン有効化
		window.addEventListener('DOMContentLoaded', () => {
			const submitButton = document.getElementById('submit');
			const timeInputs = document.querySelectorAll("input[name^='dailyReportDetailFormList'][name$='.time']");
			const contentTextareas = document.querySelectorAll("textarea[name^='dailyReportDetailFormList'][name$='.content']");

			const checkFormValidity = () => {
				let valid = false;

				timeInputs.forEach((input, index) => {
					const content = contentTextareas[index];
					if (input.value.trim() !== '' && content.value.trim() !== '') {
						valid = true;
					}
				});

				submitButton.disabled = !valid;
				submitButton.classList.toggle('disabled-form', !valid);
			};

			checkFormValidity();
			timeInputs.forEach(input => input.addEventListener('input', checkFormValidity));
			contentTextareas.forEach(textarea => textarea.addEventListener('input', checkFormValidity));
		});


	</script>


</body>

</html>